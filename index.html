<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Field Register</title>
  <link href="https://fonts.googleapis.com/css2?family=Exo:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    :root {
      --primary-dark: #112b4e;
      --primary-mid: #8895a6;
      --primary-accent: #ec7723;

      --dark-80: rgba(17, 43, 78, 0.8);
      --dark-60: rgba(17, 43, 78, 0.6);
      --dark-40: rgba(17, 43, 78, 0.4);
      --dark-20: rgba(17, 43, 78, 0.2);
      --dark-10: rgba(17, 43, 78, 0.1);
      --dark-05: rgba(17, 43, 78, 0.05);

      --accent-80: rgba(236, 119, 35, 0.8);
      --accent-60: rgba(236, 119, 35, 0.6);
      --accent-40: rgba(236, 119, 35, 0.4);
      --accent-20: rgba(236, 119, 35, 0.2);
      --accent-10: rgba(236, 119, 35, 0.1);
      --accent-05: rgba(236, 119, 35, 0.05);
    }

    body {
      font-family: 'Exo', sans-serif;
      background-color: #f9f9f9;
      color: var(--primary-dark);
      margin: 0;
      padding: 0;
      overflow-x: hidden;
    }

    header {
      background-color: var(--primary-dark);
      height: 350px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      color: white;
      padding: 0 2rem;
    }

    .header-logo {
      height: 300px;
      width: auto;
      object-fit: contain;
      max-width: 600px;
    }

    .header-title {
      flex: 1;
      text-align: center;
    }

    .header-title h1 {
      font-weight: 600;
      font-size: 3rem;
      margin: 0;
    }

    .header-spacer {
      width: 300px; /* Same as logo width to center the title */
    }

    /* Responsive media queries for header logo */
    @media screen and (max-width: 1200px) {
      .header-logo {
        height: 250px;
        max-width: 500px;
      }
      .header-spacer {
        width: 250px;
      }
      .header-title h1 {
        font-size: 2.5rem;
      }
    }

    @media screen and (max-width: 768px) {
      header {
        height: 250px;
        padding: 0 1rem;
      }
      .header-logo {
        height: 200px;
        max-width: 350px;
      }
      .header-spacer {
        width: 200px;
      }
      .header-title h1 {
        font-size: 2rem;
      }
    }

    @media screen and (max-width: 480px) {
      header {
        height: 200px;
        padding: 0 0.5rem;
      }
      .header-logo {
        height: 160px;
        max-width: 200px;
      }
      .header-spacer {
        width: 160px;
      }
      .header-title h1 {
        font-size: 1.5rem;
      }
    }

    @media screen and (max-width: 320px) {
      header {
        height: 180px;
      }
      .header-logo {
        height: 130px;
        max-width: 150px;
      }
      .header-spacer {
        width: 130px;
      }
      .header-title h1 {
        font-size: 1.3rem;
      }
    }

    .container {
      max-width: 1000px;
      margin: -50px auto 0 auto;
      padding: 2rem;
      background: white;
      border-radius: 1rem;
      box-shadow: 0 0 10px var(--dark-10);
    }

    .form-switcher {
      margin-bottom: 2rem;
    }

    .form-switcher h2 {
      font-weight: 600;
      font-size: 1.2rem;
    }

    .form-switcher button {
      background-color: var(--accent-60);
      border: none;
      color: white;
      font-weight: 600;
      padding: 0.75rem 1.5rem;
      margin: 0.5rem;
      border-radius: 0.5rem;
      cursor: pointer;
      transition: background 0.3s ease;
    }

    .form-switcher button:hover {
      background-color: var(--primary-accent);
    }

    .form-switcher button.active {
      background-color: var(--primary-accent);
    }

    .btn-back {
      background-color: #6c757d !important;
    } 
      
    .btn-back:hover {
      background-color: #5a6268 !important;
    }   
    
    .search-btn {
      background-color: var(--primary-accent);
      color: white;
      font-weight: 600;
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 0.5rem;
      cursor: pointer;
    } 
      
    .thank-you-message {
      background-color: var(--accent-10);
      border: 2px solid var(--primary-accent);
      color: var(--primary-dark);
      padding: 1rem;
      border-radius: 0.5rem;
      text-align: center;
      font-weight: 600;
      font-size: 1.1rem;
      margin-bottom: 2rem;
      display: none;
    }

    .hidden {
      display: none;
    }

    .form-section {
      margin-bottom: 2rem;
    }

    .form-section h3 {
      font-size: 1.5rem;
      margin-top: 0;
    }

    label {
      display: block;
      margin: 1rem 0 0.5rem;
      font-weight: 600;
    }

    legend {
      display: block;
      margin: 1rem 0 0.5rem;
      font-weight: 600;
    }

    input[type="text"],
    input[type="date"],
    input[type="number"],
    input[type="tel"],
    select,
    textarea {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid var(--dark-20);
      border-radius: 0.5rem;
      font-size: 1rem;
      font-family: 'Exo', sans-serif;
    }

    input[type="checkbox"] {
      margin-right: 0.5rem;
    }

    .form-footer {
      margin-top: 2rem;
      display: flex;
      justify-content: space-between;
    }

    .form-footer button {
      background-color: var(--primary-accent);
      color: white;
      font-weight: 600;
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 0.5rem;
      cursor: pointer;
    }

.field-error input {
  border: 2px solid #dc3545;
  background-color: #fff5f5;
}

.field-error label {
  color: #dc3545;
  font-weight: bold;
}

.form-wrapper {
  border: 1px solid var(--dark-20); /* Subtle border */
  padding: 1.5rem;
  border-radius: 1rem;
  max-width: 100%;
  box-sizing: border-box;
  overflow-x: auto; /* Ensure horizontal scrolling if content overflows */
}

input,
select,
textarea {
  max-width: 100%;
  box-sizing: border-box;
}

/* Specific styling for discipline checkboxes and their error messages */
.discipline-checkbox-group.field-error {
  border: 2px solid #dc3545;
  padding: 10px;
  border-radius: 0.5rem;
  background-color: #fff5f5;
}

.discipline-checkbox-group.field-error label {
  color: #dc3545;
}

    .week-ending-display {
      background-color: var(--accent-10);
      border: 2px solid var(--primary-accent);
      padding: 1rem;
      border-radius: 0.5rem;
      text-align: center;
      font-weight: 600;
      font-size: 1.1rem;
      margin-bottom: 1rem;
    }

    /* Style for the conditional discipline fields */
    .discipline-conditional-fields {
        border-left: 3px solid var(--primary-accent);
        padding-left: 15px;
        margin-top: 10px;
        margin-bottom: 15px;
        background-color: var(--accent-05);
        border-radius: 0.5rem;
        padding-top: 10px;
        padding-bottom: 10px;
    }

/* Styles for the main discipline checkboxes' labels */
.discipline-checkbox-group > div label {
    font-weight: bold; /* Make these labels bold */
    color: var(--primary-dark); /* Use a darker color */
    display: inline; /* Keep them inline with their checkboxes */
    margin-left: 5px; /* Add some space if the input is first */
    /* Add any other styles specific to these main labels */
}

/* Styles for labels within the conditional discipline fields */
.discipline-conditional-fields label {
    font-size: 0.95rem; /* Slightly smaller font for these */
    color: var(--primary-mid); /* Use a lighter color */
    display: inline; /* Keep them inline with their checkboxes */
    margin-bottom: 0.5rem; /* Add space below them */    }

    .discipline-conditional-fields input[type="number"] {
        width: calc(100% - 20px); /* Adjust width to fit padding */
        margin-bottom: 10px;
    }
/* More specifically, styles for the day checkboxes' labels */
.discipline-conditional-fields .days-checkbox-group label {
    font-weight: normal; /* Ensure they are not bold */
    color: var(--primary-dark); /* Can revert to primary-dark for contrast */
    display: inline; /* Keep them inline with their checkboxes */
    margin-left: 5px; /* Space next to the checkbox */
    margin-bottom: 0; /* Remove block margin */
}
    .discipline-conditional-fields .days-checkbox-group div {
        flex: 1 1 auto; /* Allow items to grow and shrink */
        min-width: 100px; /* Minimum width for each day checkbox */
    }
    .discipline-conditional-fields .days-checkbox-group input[type="checkbox"] {
        margin-right: 5px;
    }
    .error-field {
        border: 2px solid red !important;
        background-color: #ffe0e0 !important;
    }
    /* Optional: Style for the error messages */
    .error-message {
        margin-top: 5px;
        margin-bottom: 10px;
    }

.pitlinkin-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 15px;
  width: 100%;
}

.left-group {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  flex-shrink: 0;
}

.right-group {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  flex: 1;
}

.right-group label {
  white-space: nowrap; /* prevents label from wrapping */
 }

#pitlinkin-PitA-Note-ID {
  width: 100%;
}

.or-divider {
  display: flex;
  align-items: center;
  text-align: center;
  margin: 2rem 0;
  font-family: 'Exo', sans-serif;
}

.or-divider .line {
  flex-grow: 1;
  height: 1px;
  background-color: var(--accent-60);
  border: none;
}

.or-divider .or-text {
  padding: 0 1rem;
  font-weight: 600;
  color: var(--primary-accent);
  font-size: 1rem;
  white-space: nowrap;
}

  .disabled-label {
    color: gray;
    font-style: italic;
  }

.field-error-names {
  border: 2px solid red;
}

.crew-checkbox {
      border: 1px solid #ccc;
      border-radius: 0.5rem;
      background-color: #fff;
      padding: 1rem;
      max-height: 200px;
      overflow-y: auto;
      font-family: 'Exo', sans-serif;
    }
    .crew-checkbox label {
      display: block;
      margin-bottom: 0.25rem;
      cursor: pointer;
      color: var(--primary-dark);
    }
    .crew-checkbox input[type="checkbox"] {
      accent-color: var(--primary-accent);
      margin-right: 0.5rem;
      transform: scale(1.1);
    }
    .crew-checkbox p {
      color: var(--primary-mid);
      font-style: italic;
      margin: 0 0 0.5rem 0;
    }

  </style>

</head>
<body>
  <header>
    <img src="Field Register Header.png" alt="Field Register Logo" class="header-logo" />
    <div class="header-title">
      <h1>Field Register</h1>
    </div>
    <div class="header-spacer"></div>
  </header>

  <main class="container">
  <div class="form-wrapper">
  <div id="thank-you-message" class="thank-you-message" style="display: none;">
    <h3 id="message-title">Thank you!</h3>
    <p id="message-body">Your form has been submitted successfully.</p>
  </div>
    
    <section class="form-switcher">
      <h2>Please select which form you require:</h2>
      <button id="btn-bog" onclick="showForm('bog')">Boots on Ground</button>
      <button id="btn-progress" onclick="showForm('progress')">Progress Register</button>

    </section>

    <div id="form-bog" class="form-section hidden">
      <h3>Daily Pre-Start: Boots on Ground: Genus - Aura project</h3>
      <p>Please complete prior to starting work. <strong><u>Submission must be no later than 8am.</u></strong><br>This does not replace the JHA.</p>
      <form id="bog-form" onsubmit="validateBogForm()">

        <label for="bog-project">Project</label>
            <select id="bog-project" name="bog-project" required>
          <option value="Kalgoorlie-Wallaroo" selected>Kalgoorlie - Wallaroo</option>
        </select>

        <label for="bog-date">Date</label>
        <input type="date" id="bog-date" name="bog-date" required />

	<label for="bog-mob">
	<input type="checkbox" id="bog-mob" name="bog-mob" />
	Mobilisation Day
	</label>

	<label for="bog-demob">
	<input type="checkbox" id="bog-demob" name="bog-demob" />
	De-mobilisation Day
	</label>

        <label for="bog-company-name">Your Company Name</label>
        <select id="bog-company-name" name="bog-company-name" required>
          <option value="">Select one</option>
          <option value="Genus Services">Genus Services</option>
          <option value="JNJTech Services">JNJTech Services</option>
          <option value="MNC Drilling">MNC Drilling</option>
        </select>

<label for="bog-estimated-start-time">Estimated Start Time</label>
<select id="bog-estimated-start-time" name="bog-estimated-start-time" required></select>

<label for="bog-estimated-finish-time">Estimated Finish Time</label>
<select id="bog-estimated-finish-time" name="bog-estimated-finish-time" required></select>

<!-- Hidden fields to store timestamps in ISO format -->
<input type="hidden" id="bog-estimated-start-timestamp" name="bog-estimated-start-timestamp" />
<input type="hidden" id="bog-estimated-finish-timestamp" name="bog-estimated-finish-timestamp" />
        
        <label for="bog-discipline">Discipline</label>
        <select id="bog-discipline" name="bog-discipline" required>
          <option value="">Select one</option>
     <optgroup label="Construction">
          <option value="RRP">Rod, Rope & Prove</option>
          <option value="Blockage Repair">Blockage Repair</option>
          <option value="Plough">Plough</option>
          <option value="Horizontal Directional Drilling">Horizontal Directional Drilling</option>
          <option value="Trenching">Trenching</option>
          <option value="ACM Removal">ACM Removal</option>
          <option value="Pit Installation/Remediation">Pit Installation/Remediation</option>
          <option value="Reinstatement">Reinstatement</option>
          <option value="Cable Hauling">Cable Hauling</option>
          <option value="Traffic Management">Traffic Management</option>
          <option value="Supervision">Supervision</option>
     </optgroup>
        </select>

            <label for="bog-Location">Location</label>
        <textarea id="bog-Location" name="bog-Location" placeholder="Enter sheet number and grid reference" required></textarea>

    <label for="bog-site-contact">Onsite Crew Lead Name</label>
    <div id="bog-site-contact" class="crew-checkbox"></div>
    <input type="hidden" id="bog-site-contact-hidden" name="bog-site-contact" required />

        <label for="bog-onsite-crew-lead-mobile">Onsite Crew Lead Mobile</label>
        <input type="tel" id="bog-onsite-crew-lead-mobile" name="bog-onsite-crew-lead-mobile" pattern="04\d{8}" maxlength="10" placeholder="Enter 10-digit number" oninvalid="this.setCustomValidity('Enter number as 04xxxxxxxx')" oninput="this.setCustomValidity('')" required />

        <label for="bog-onsite-crew-lead-email">Onsite Crew Lead Email (optional)</label>
        <input type="text" id="bog-onsite-crew-lead-email" name="bog-onsite-crew-lead-email" />
        
        <label for="bog-Number-of-People-at-Location">Number of People in Crew at Location</label>
        <input type="number" id="bog-Number-of-People-at-Location" name="bog-Number-of-People-at-Location" min="1" step="1" required>
        
    <label for="bog-crews-names">Select Crew Members</label>
    <div id="bog-crews-names" class="crew-checkbox">
      <p>Select crew members for this location...</p>
    </div>
    <input type="hidden" id="bog-crews-names-hidden" name="bog-crews-names" required />
       
        <label for="bog-Genus-FCM">Your Genus FCM</label>
        <select id="bog-Genus-FCM" name="bog-Genus-FCM" required>
          <option value="">Select one</option>
          <option value="Alex McConville">Alex McConville</option>
          <option value="Damian Watson">Damian Watson</option>
        </select>
<br><br>
<div>
  <fieldset id="bog-swms-fieldset">
    <legend><strong>Discipline with task Specific SWMS</strong></legend>
    <p>
      (SWMS-SHEQ-CMS-0011 Site Establishment, SWMS-SHEQ-CMS-0001 Access to Pits & Manholes - required on all sites, SWMS-SHEQ-CMS-0006 Asbestos (ACM) required for all ACM sites)
    </p>
    <p>All workers to have signed into Task SWMS being utilised with copy available - latest version.</p>

    <input type="checkbox" name="bog-SWMS[]" value="Scoping" /> Scoping (0017 Surveying & Scoping)<br />
    <input type="checkbox" name="bog-SWMS[]" value="Ploughing" /> Ploughing (0026 Ploughing & Cable Laying)<br />
    <input type="checkbox" name="bog-SWMS[]" value="Trenching" /> Trenching (0012 Excavation & Trenching)<br />
    <input type="checkbox" name="bog-SWMS[]" value="Drilling" /> Drilling (0016 Directional Boring, 0012 Excavation & Trenching)<br />
    <input type="checkbox" name="bog-SWMS[]" value="Pit Installation" /> Pit Installation (0002 Installing Replacing Repairing Pits Manholes)<br />
    <input type="checkbox" name="bog-SWMS[]" value="Hauling" /> Hauling (0008 Rod Roping & Cable Hauling)<br />
    <input type="checkbox" name="bog-SWMS[]" value="Splicing" /> Splicing (0007 Cable Jointing)<br />
    <input type="checkbox" name="bog-SWMS[]" value="Clear Blockage" /> Clear Blockage (0008 Rod Roping & Cable Hauling)<br />
    <input type="checkbox" name="bog-SWMS[]" value="Service Locator" /> Service Locator (0012 Excavation & Trenching)<br />
    <input type="checkbox" name="bog-SWMS[]" value="Reinstatement" /> Reinstatement (0012 Excavation & Trenching)<br />

    <p id="swms-error" style="color: red; display: none;">Please select at least one SWMS discipline.</p>
  </fieldset>
</div>
                
<div id="bog-swms-section">
  <id="bog-jha-label">
    <label for="bog-jha-uploaded">
      I confirm all workers have been inducted and have signed onto the JHA.
    </label>
    <input type="checkbox" id="bog-jha-uploaded" name="bog-jha-uploaded" required>
    Please induct all visitors to JHA and complete prior to starting at each site.
  </div>

<div style="margin: 20px 0;">
  <label for="bog-jha-photos">
    Please provide a photo of the signed JHA (GPS time/date enabled)
    <br>
    <small style="color: #666;">
      Requires photo of front page and signed last page of the JHA
    </small>
  </label>

  <input 
    type="file" 
    id="bog-jha-photos" 
    name="bog_jha_photos[]"
    accept="image/*"
    multiple
    capture="environment"
    required
    style="margin-top: 10px; width: 100%; padding: 8px; border: 1px solid var(--dark-20); border-radius: 0.5rem; font-size: 1rem; font-family: 'Exo', sans-serif;"
  >

  <!-- Optional hint for users -->
  <p style="font-size: 0.9em; color: #555; margin-top: 8px;">
    You can select multiple photos or take new ones with your camera (enable GPS for time/date stamp).
  </p>
</div>

        <label for="bog-ACM">Will you be disturbing/modifying any possible ACM while onsite?</label>
        <select id="bog-ACM" name="bog-ACM" onchange="toggleACMField()" required>
          <option value="">Select one</option>
          <option value="Yes">Yes</option>
          <option value="No">No</option>
        </select>

<!-- Conditional Field -->
<div id="bog-acm-notification-field" style="display: none; margin-top: 10px;">
  <label for="bog-acm-yes">If yes, have you received your Genus ACM Removal Notification Code and placed on your Construction</label>
  Required for all ACM Pit replacement work, with Company Class B, worker to have remove Non-Friable accreditation with ACM supervisor in the vicinity.<br />
  <select id="bog-acm-yes" name="bog-acm-yes">
          <option value="">Select one</option>
          <option value="Yes">Yes, continue</option>
          <option value="No">No, stop work and contact your Genus FCM</option>
        </select>
</div>
                
<div id="bog-guards">
  <label for="bog-guards-checkbox">Are appropriate gas monitoring and trench guards in place?</label>
  <input type="checkbox" id="bog-guards-checkbox" name="bog-guards" /> Refer to HSE Guidance Note - Spot Sampling (Manhole) Gas Action Chart.
</div> 
               
<div id="bog-excavation">
  <label for="bog-excavation-checkbox">Is excavation work being conducted today?</label>
  <input type="checkbox" id="bog-excavation-checkbox" name="bog-excavation" /> Refer to HSE Guidance Note â€“ Construction JHA and Excavation permit process
</div>

<div style="margin: 20px 0;">
  <label for="bog-site-photos">
    Please provide a photo of your first site set-up for today (GPS time/date enabled)
    <br>
    <small style="color: #666;">
      Requires photo of a safe site set-up
    </small>
  </label>

  <input 
    type="file" 
    id="bog-site-photos" 
    name="bog_site_photos[]"
    accept="image/*"
    multiple
    capture="environment"
    required
    style="margin-top: 10px; width: 100%; padding: 8px; border: 1px solid var(--dark-20); border-radius: 0.5rem; font-size: 1rem; font-family: 'Exo', sans-serif;"
  >

  <!-- Optional hint for users -->
  <p style="font-size: 0.9em; color: #555; margin-top: 8px;">
    You can select multiple photos or take new ones with your camera (enable GPS for time/date stamp).
  </p>
</div>

        <label for="bog-comments">Additional Comments? Escalate SHEQ concerns to your Genus FCM/Supervisor or SHEQ Advisor</label>
        <textarea id="bog-comments" name="bog-comments" placeholder="Track required actions in MyOsh with SHEQ support"></textarea>

        <div class="form-footer">
          <button type="button" class="btn-back" onclick="confirmReset('bog')">Back</button>
          <button type="submit">Submit BOG</button>
        </div>
      </form>
    </div>

<div id="form-progress" class="form-section hidden">
  <h3>Progress Register: Genus Aura project</h3>
  <form id="progress-form" onsubmit="return validateProgressForm()">

    <label for="progress-project">Project</label>
    <select id="progress-project" name="progress-project" required>
      <option value="Kalgoorlie-Wallaroo" selected>Kalgoorlie - Wallaroo</option>
    </select>

    <label for="progress-date">Date</label>
    <input type="date" id="progress-date" name="progress-date" required />

    <label for="progress-company-name">Your Company Name</label>
    <select id="progress-company-name" name="progress-company-name" required>
      <option value="">Select one</option>
      <option value="Genus Services">Genus Services</option>
      <option value="JNJTech Services">JNJTech Services</option>
      <option value="MNC Drilling">MNC Drilling</option>
    </select>

    <label for="progress-site-contact">Onsite Crew Lead Name</label>
    <div id="progress-site-contact" class="crew-checkbox"></div>
    <input type="hidden" id="progress-site-contact-hidden" name="progress-site-contact" required />

    <label for="progress-onsite-crew-lead-mobile">Onsite Crew Lead Mobile</label>
    <input type="tel" id="progress-onsite-crew-lead-mobile" name="progress-onsite-crew-lead-mobile" pattern="04\d{8}" maxlength="10" placeholder="Enter 10-digit number" oninvalid="this.setCustomValidity('Enter number as 04xxxxxxxx')" oninput="this.setCustomValidity('')" required />

    <label for="progress-Location">Location</label>
    <textarea id="progress-Location" name="progress-Location" placeholder="Add sheet numbers for work completed" required></textarea>

    <fieldset>
      <legend>Select the activity type(s) your company has completed today:</legend>
      <div class="discipline-checkbox-group">
        <!-- Plough - Progress -->
        <div>
          <input type="checkbox" id="discipline-plough-progress" name="discipline[]" value="plough-progress" onchange="toggleDisciplineFields(this)" />
          <label for="discipline-plough-progress">Plough</label>
        </div>

<div id="discipline-plough-progress-fields" class="discipline-conditional-fields" style="display: none;">
  <label for="plough-progress-qty">Metres Completed:</label>
  <input type="number" id="plough-progress-qty" name="plough-progress-qty" min="0" step="0.1" />

  <label for="plough-progress-cable-marking-photos" style="margin-top: 15px;">
    Cable Marker Photos - Start and End of Day (GPS time/date enabled)
    <br>
    <small style="color: #666;">
      Capture photos showing cable markers at start and end of day
    </small>
  </label>
  <input 
    type="file" 
    id="plough-progress-cable-marking-photos" 
    name="plough_progress_cable_marking_photos[]"
    accept="image/*"
    multiple
    capture="environment"
    style="margin-top: 10px; width: calc(100% - 20px); padding: 8px; border: 1px solid var(--dark-20); border-radius: 0.5rem; font-size: 1rem; font-family: 'Exo', sans-serif; background-color: white;"
  >
  <p style="font-size: 0.9em; color: #555; margin-top: 8px;">
    You can select multiple photos or take new ones with your camera (enable GPS for time/date stamp).
  </p>
</div>

        <!-- Bore - Progress -->
        <div>
          <input type="checkbox" id="discipline-bore-progress" name="discipline[]" value="bore-progress" onchange="toggleDisciplineFields(this)" />
          <label for="discipline-bore-progress">Bore</label>
        </div>

        <div id="discipline-bore-progress-fields" class="discipline-conditional-fields" style="display: none;">
          <!-- PE63 Size -->
          <div>
            <input type="checkbox" id="discipline-bore-pe63-progress" name="bore-size[]" value="bore-pe63-progress" onchange="toggleDisciplineFields(this)" />
            <label for="discipline-bore-pe63-progress">Size - PE63</label>
          </div>

          <div id="discipline-bore-pe63-progress-fields" class="discipline-conditional-fields" style="display: none;">
            <label for="bore-pe63-progress-qty">Metres Completed:</label>
            <input type="number" id="bore-pe63-progress-qty" name="bore-pe63-progress-qty" min="0" step="0.1" />

              <label for="bore-pe63-progress-photos" style="margin-top: 15px;">
    Before and After - PE63 (GPS time/date enabled)
    <br>
    <small style="color: #666;">
      Capture photos showing before and after boring section
    </small>
  </label>
  <input 
    type="file" 
    id="bore-pe63-progress-photos" 
    name="bore_pe63_progress_photos[]"
    accept="image/*"
    multiple
    capture="environment"
    style="margin-top: 10px; width: calc(100% - 20px); padding: 8px; border: 1px solid var(--dark-20); border-radius: 0.5rem; font-size: 1rem; font-family: 'Exo', sans-serif; background-color: white;"
  >
  <p style="font-size: 0.9em; color: #555; margin-top: 8px;">
    You can select multiple photos or take new ones with your camera (enable GPS for time/date stamp).
  </p>
          </div>

          <!-- PE110 Size -->
          <div>
            <input type="checkbox" id="discipline-bore-pe110-progress" name="bore-size[]" value="bore-pe110-progress" onchange="toggleDisciplineFields(this)" />
            <label for="discipline-bore-pe110-progress">Size - PE110</label>
          </div>

          <div id="discipline-bore-pe110-progress-fields" class="discipline-conditional-fields" style="display: none;">
            <label for="bore-pe110-progress-qty">Metres Completed:</label>
            <input type="number" id="bore-pe110-progress-qty" name="bore-pe110-progress-qty" min="0" step="0.1" />

              <label for="bore-pe110-progress-photos" style="margin-top: 15px;">
    Before and After - PE110 (GPS time/date enabled)
    <br>
    <small style="color: #666;">
      Capture photos showing before and after boring section
    </small>
  </label>
  <input 
    type="file" 
    id="bore-pe110-progress-photos" 
    name="bore_pe110_progress_photos[]"
    accept="image/*"
    multiple
    capture="environment"
    style="margin-top: 10px; width: calc(100% - 20px); padding: 8px; border: 1px solid var(--dark-20); border-radius: 0.5rem; font-size: 1rem; font-family: 'Exo', sans-serif; background-color: white;"
  >
  <p style="font-size: 0.9em; color: #555; margin-top: 8px;">
    You can select multiple photos or take new ones with your camera (enable GPS for time/date stamp).
  </p>
          </div>
        </div>

        <!-- Trench - Progress -->
        <div>
          <input type="checkbox" id="discipline-trench-progress" name="discipline[]" value="trench-progress" onchange="toggleDisciplineFields(this)" />
          <label for="discipline-trench-progress">Trench</label>
        </div>

        <div id="discipline-trench-progress-fields" class="discipline-conditional-fields" style="display: none;">
          <!-- P50 Size -->
          <div>
            <input type="checkbox" id="discipline-trench-p50-progress" name="trench-size[]" value="trench-p50-progress" onchange="toggleDisciplineFields(this)" />
            <label for="discipline-trench-p50-progress">Size - P50</label>
          </div>

          <div id="discipline-trench-p50-progress-fields" class="discipline-conditional-fields" style="display: none;">
            <label for="trench-p50-progress-qty">Metres Completed:</label>
            <input type="number" id="trench-p50-progress-qty" name="trench-p50-progress-qty" min="0" step="0.1" />

              <label for="trench-p50-progress-photos" style="margin-top: 15px;">
    Before and After - P50 (GPS time/date enabled)
    <br>
    <small style="color: #666;">
      Capture photos showing before and after trenching section
    </small>
  </label>
  <input 
    type="file" 
    id="trench-p50-progress-photos" 
    name="trench_p50_progress_photos[]"
    accept="image/*"
    multiple
    capture="environment"
    style="margin-top: 10px; width: calc(100% - 20px); padding: 8px; border: 1px solid var(--dark-20); border-radius: 0.5rem; font-size: 1rem; font-family: 'Exo', sans-serif; background-color: white;"
  >
  <p style="font-size: 0.9em; color: #555; margin-top: 8px;">
    You can select multiple photos or take new ones with your camera (enable GPS for time/date stamp).
  </p>
          </div>

          <!-- P100 Size -->
          <div>
            <input type="checkbox" id="discipline-trench-p100-progress" name="trench-size[]" value="trench-p100-progress" onchange="toggleDisciplineFields(this)" />
            <label for="discipline-trench-p100-progress">Size - P100</label>
          </div>

          <div id="discipline-trench-p100-progress-fields" class="discipline-conditional-fields" style="display: none;">
            <label for="trench-p100-progress-qty">Metres Completed:</label>
            <input type="number" id="trench-p100-progress-qty" name="trench-p100-progress-qty" min="0" step="0.1" />

              <label for="trench-p100-progress-photos" style="margin-top: 15px;">
    Before and After - P100 (GPS time/date enabled)
    <br>
    <small style="color: #666;">
      Capture photos showing before and after trenching section
    </small>
  </label>
  <input 
    type="file" 
    id="trench-p100-progress-photos" 
    name="trench_p100_progress_photos[]"
    accept="image/*"
    multiple
    capture="environment"
    style="margin-top: 10px; width: calc(100% - 20px); padding: 8px; border: 1px solid var(--dark-20); border-radius: 0.5rem; font-size: 1rem; font-family: 'Exo', sans-serif; background-color: white;"
  >
  <p style="font-size: 0.9em; color: #555; margin-top: 8px;">
    You can select multiple photos or take new ones with your camera (enable GPS for time/date stamp).
  </p>
          </div>
        </div>

        <!-- Hauling - Progress -->
        <div>
          <input type="checkbox" id="discipline-hauling-progress" name="discipline[]" value="hauling-progress" onchange="toggleDisciplineFields(this)" />
          <label for="discipline-hauling-progress">Hauling (per cable)</label>
        </div>

        <div id="discipline-hauling-progress-fields" class="discipline-conditional-fields" style="display: none;">
          <label for="hauling-progress-qty">Metres Completed:</label>
          <input type="number" id="hauling-progress-qty" name="hauling-progress-qty" min="0" step="0.1" />

  <label for="hauling-progress-cable-marking-photos" style="margin-top: 15px;">
    Cable Marker Photos - Start and End hauled section (GPS time/date enabled)
    <br>
    <small style="color: #666;">
      Capture photos showing cable markers at start and end of hauled section
    </small>
  </label>
  <input 
    type="file" 
    id="hauling-progress-cable-marking-photos" 
    name="hauling_progress_cable_marking_photos[]"
    accept="image/*"
    multiple
    capture="environment"
    style="margin-top: 10px; width: calc(100% - 20px); padding: 8px; border: 1px solid var(--dark-20); border-radius: 0.5rem; font-size: 1rem; font-family: 'Exo', sans-serif; background-color: white;"
  >
  <p style="font-size: 0.9em; color: #555; margin-top: 8px;">
    You can select multiple photos or take new ones with your camera (enable GPS for time/date stamp).
  </p>
</div>

        <!-- RRP - Progress -->
        <div>
          <input type="checkbox" id="discipline-rrp-progress" name="discipline[]" value="rrp-progress" onchange="toggleDisciplineFields(this)" />
          <label for="discipline-rrp-progress">Rod, Rope & Prove</label>
        </div>

        <div id="discipline-rrp-progress-fields" class="discipline-conditional-fields" style="display: none;">
          <label for="rrp-progress-qty">Metres Completed:</label>
          <input type="number" id="rrp-progress-qty" name="rrp-progress-qty" min="0" step="0.1" />

  <label for="rrp-progress-tag-photos" style="margin-top: 15px;">
    RRP Photos (GPS time/date enabled)
    <br>
    <small style="color: #666;">
      Capture photos showing mandrel and tagged rope in duct
    </small>
  </label>
  <input 
    type="file" 
    id="rrp-progress-tag-photos" 
    name="rrp_progress_tag_photos[]"
    accept="image/*"
    multiple
    capture="environment"
    style="margin-top: 10px; width: calc(100% - 20px); padding: 8px; border: 1px solid var(--dark-20); border-radius: 0.5rem; font-size: 1rem; font-family: 'Exo', sans-serif; background-color: white;"
  >
  <p style="font-size: 0.9em; color: #555; margin-top: 8px;">
    You can select multiple photos or take new ones with your camera (enable GPS for time/date stamp).
  </p>
</div>

        <!-- Blockages - Progress -->
        <div>
          <input type="checkbox" id="discipline-blockages-progress" name="discipline[]" value="blockages-progress" onchange="toggleDisciplineFields(this)" />
          <label for="discipline-blockages-progress">Blockages</label>
        </div>

        <div id="discipline-blockages-progress-fields" class="discipline-conditional-fields" style="display: none;">
          <label for="blockages-progress-qty">Blockages Cleared:</label>
          <input type="number" id="blockages-progress-qty" name="blockages-progress-qty" min="0" step="1" />

  <label for="blockages-progress-tag-photos" style="margin-top: 15px;">
    Duct Blockage Photos (GPS time/date enabled)
    <br>
    <small style="color: #666;">
      Capture photos showing blockage location, exposed duct, repaired duct and rope in duct
    </small>
  </label>
  <input 
    type="file" 
    id="blockages-progress-tag-photos" 
    name="blockages_progress_tag_photos[]"
    accept="image/*"
    multiple
    capture="environment"
    style="margin-top: 10px; width: calc(100% - 20px); padding: 8px; border: 1px solid var(--dark-20); border-radius: 0.5rem; font-size: 1rem; font-family: 'Exo', sans-serif; background-color: white;"
  >
  <p style="font-size: 0.9em; color: #555; margin-top: 8px;">
    You can select multiple photos or take new ones with your camera (enable GPS for time/date stamp).
  </p>
</div>

        <!-- Pits - Progress -->
        <div>
          <input type="checkbox" id="discipline-pit-progress" name="discipline[]" value="pit-progress" onchange="toggleDisciplineFields(this)" />
          <label for="discipline-pit-progress">Pits</label>
        </div>

        <div id="discipline-pit-progress-fields" class="discipline-conditional-fields" style="display: none;">
          
          <!-- New Pits -->
          <div>
            <input type="checkbox" id="discipline-pit-new-progress" name="pit-type[]" value="pit-new-progress" onchange="toggleDisciplineFields(this)" />
            <label for="discipline-pit-new-progress">New</label>
          </div>

          <div id="discipline-pit-new-progress-fields" class="discipline-conditional-fields" style="display: none;">
            
            <!-- C8 Size -->
            <div>
              <input type="checkbox" id="discipline-pit-new-c8-progress" name="pit-new-size[]" value="pit-new-c8-progress" onchange="toggleDisciplineFields(this)" />
              <label for="discipline-pit-new-c8-progress">C8</label>
            </div>

            <div id="discipline-pit-new-c8-progress-fields" class="discipline-conditional-fields" style="display: none;">
              <label for="pit-new-c8-progress-qty">Quantity:</label>
              <input type="number" id="pit-new-c8-progress-qty" name="pit-new-c8-progress-qty" min="0" step="1" />

  <label for="pit-new-c8-progress-photos" style="margin-top: 15px;">
    New Pit Photos (GPS time/date enabled)
    <br>
    <small style="color: #666;">
      Capture photos showing before and after pit installation
    </small>
  </label>
  <input 
    type="file" 
    id="pit-new-c8-progress-photos" 
    name="pit_new_c8_progress_photos[]"
    accept="image/*"
    multiple
    capture="environment"
    style="margin-top: 10px; width: calc(100% - 20px); padding: 8px; border: 1px solid var(--dark-20); border-radius: 0.5rem; font-size: 1rem; font-family: 'Exo', sans-serif; background-color: white;"
  >
  <p style="font-size: 0.9em; color: #555; margin-top: 8px;">
    You can select multiple photos or take new ones with your camera (enable GPS for time/date stamp).
  </p>
</div>

            <!-- C9 Size -->
            <div>
              <input type="checkbox" id="discipline-pit-new-c9-progress" name="pit-new-size[]" value="pit-new-c9-progress" onchange="toggleDisciplineFields(this)" />
              <label for="discipline-pit-new-c9-progress">C9</label>
            </div>

            <div id="discipline-pit-new-c9-progress-fields" class="discipline-conditional-fields" style="display: none;">
              <label for="pit-new-c9-progress-qty">Quantity:</label>
              <input type="number" id="pit-new-c9-progress-qty" name="pit-new-c9-progress-qty" min="0" step="1" />

  <label for="pit-new-c9-progress-photos" style="margin-top: 15px;">
    New Pit Photos (GPS time/date enabled)
    <br>
    <small style="color: #666;">
      Capture photos showing before and after pit installation
    </small>
  </label>
  <input 
    type="file" 
    id="pit-new-c9-progress-photos" 
    name="pit_new_c9_progress_photos[]"
    accept="image/*"
    multiple
    capture="environment"
    style="margin-top: 10px; width: calc(100% - 20px); padding: 8px; border: 1px solid var(--dark-20); border-radius: 0.5rem; font-size: 1rem; font-family: 'Exo', sans-serif; background-color: white;"
  >
  <p style="font-size: 0.9em; color: #555; margin-top: 8px;">
    You can select multiple photos or take new ones with your camera (enable GPS for time/date stamp).
  </p>
</div>

            <!-- Manhole Size -->
            <div>
              <input type="checkbox" id="discipline-pit-new-manhole-progress" name="pit-new-size[]" value="pit-new-manhole-progress" onchange="toggleDisciplineFields(this)" />
              <label for="discipline-pit-new-manhole-progress">Manhole</label>
            </div>

            <div id="discipline-pit-new-manhole-progress-fields" class="discipline-conditional-fields" style="display: none;">
              <label for="pit-new-manhole-progress-qty">Quantity:</label>
              <input type="number" id="pit-new-manhole-progress-qty" name="pit-new-manhole-progress-qty" min="0" step="1" />

  <label for="pit-new-manhole-progress-photos" style="margin-top: 15px;">
    New Manhole Photos (GPS time/date enabled)
    <br>
    <small style="color: #666;">
      Capture photos showing before and after manhole installation
    </small>
  </label>
  <input 
    type="file" 
    id="pit-new-manhole-progress-photos" 
    name="pit_new_manhole_progress_photos[]"
    accept="image/*"
    multiple
    capture="environment"
    style="margin-top: 10px; width: calc(100% - 20px); padding: 8px; border: 1px solid var(--dark-20); border-radius: 0.5rem; font-size: 1rem; font-family: 'Exo', sans-serif; background-color: white;"
  >
  <p style="font-size: 0.9em; color: #555; margin-top: 8px;">
    You can select multiple photos or take new ones with your camera (enable GPS for time/date stamp).
  </p>
</div>

            <!-- P5 Size -->
            <div>
              <input type="checkbox" id="discipline-pit-new-p5-progress" name="pit-new-size[]" value="pit-new-p5-progress" onchange="toggleDisciplineFields(this)" />
              <label for="discipline-pit-new-p5-progress">P5</label>
            </div>

            <div id="discipline-pit-new-p5-progress-fields" class="discipline-conditional-fields" style="display: none;">
              <label for="pit-new-p5-progress-qty">Quantity:</label>
              <input type="number" id="pit-new-p5-progress-qty" name="pit-new-p5-progress-qty" min="0" step="1" />

  <label for="pit-new-p5-progress-photos" style="margin-top: 15px;">
    New Pit Photos (GPS time/date enabled)
    <br>
    <small style="color: #666;">
      Capture photos showing before and after pit installation
    </small>
  </label>
  <input 
    type="file" 
    id="pit-new-p5-progress-photos" 
    name="pit_new_p5_progress_photos[]"
    accept="image/*"
    multiple
    capture="environment"
    style="margin-top: 10px; width: calc(100% - 20px); padding: 8px; border: 1px solid var(--dark-20); border-radius: 0.5rem; font-size: 1rem; font-family: 'Exo', sans-serif; background-color: white;"
  >
  <p style="font-size: 0.9em; color: #555; margin-top: 8px;">
    You can select multiple photos or take new ones with your camera (enable GPS for time/date stamp).
  </p>
</div>

            <!-- P6 Size -->
            <div>
              <input type="checkbox" id="discipline-pit-new-p6-progress" name="pit-new-size[]" value="pit-new-p6-progress" onchange="toggleDisciplineFields(this)" />
              <label for="discipline-pit-new-p6-progress">P6</label>
            </div>

            <div id="discipline-pit-new-p6-progress-fields" class="discipline-conditional-fields" style="display: none;">
              <label for="pit-new-p6-progress-qty">Quantity:</label>
              <input type="number" id="pit-new-p6-progress-qty" name="pit-new-p6-progress-qty" min="0" step="1" />

  <label for="pit-new-p6-progress-photos" style="margin-top: 15px;">
    New Pit Photos (GPS time/date enabled)
    <br>
    <small style="color: #666;">
      Capture photos showing before and after pit installation
    </small>
  </label>
  <input 
    type="file" 
    id="pit-new-p6-progress-photos" 
    name="pit_new_p6_progress_photos[]"
    accept="image/*"
    multiple
    capture="environment"
    style="margin-top: 10px; width: calc(100% - 20px); padding: 8px; border: 1px solid var(--dark-20); border-radius: 0.5rem; font-size: 1rem; font-family: 'Exo', sans-serif; background-color: white;"
  >
  <p style="font-size: 0.9em; color: #555; margin-top: 8px;">
    You can select multiple photos or take new ones with your camera (enable GPS for time/date stamp).
  </p>
</div>

            <!-- P8 Size -->
            <div>
              <input type="checkbox" id="discipline-pit-new-p8-progress" name="pit-new-size[]" value="pit-new-p8-progress" onchange="toggleDisciplineFields(this)" />
              <label for="discipline-pit-new-p8-progress">P8</label>
            </div>

            <div id="discipline-pit-new-p8-progress-fields" class="discipline-conditional-fields" style="display: none;">
              <label for="pit-new-p8-progress-qty">Quantity:</label>
              <input type="number" id="pit-new-p8-progress-qty" name="pit-new-p8-progress-qty" min="0" step="1" />

  <label for="pit-new-p8-progress-photos" style="margin-top: 15px;">
    New Pit Photos (GPS time/date enabled)
    <br>
    <small style="color: #666;">
      Capture photos showing before and after pit installation
    </small>
  </label>
  <input 
    type="file" 
    id="pit-new-p8-progress-photos" 
    name="pit_new_p8_progress_photos[]"
    accept="image/*"
    multiple
    capture="environment"
    style="margin-top: 10px; width: calc(100% - 20px); padding: 8px; border: 1px solid var(--dark-20); border-radius: 0.5rem; font-size: 1rem; font-family: 'Exo', sans-serif; background-color: white;"
  >
  <p style="font-size: 0.9em; color: #555; margin-top: 8px;">
    You can select multiple photos or take new ones with your camera (enable GPS for time/date stamp).
  </p>
</div>

            <!-- P9 Size -->
            <div>
              <input type="checkbox" id="discipline-pit-new-p9-progress" name="pit-new-size[]" value="pit-new-p9-progress" onchange="toggleDisciplineFields(this)" />
              <label for="discipline-pit-new-p9-progress">P9</label>
            </div>

            <div id="discipline-pit-new-p9-progress-fields" class="discipline-conditional-fields" style="display: none;">
              <label for="pit-new-p9-progress-qty">Quantity:</label>
              <input type="number" id="pit-new-p9-progress-qty" name="pit-new-p9-progress-qty" min="0" step="1" />

  <label for="pit-new-p9-progress-photos" style="margin-top: 15px;">
    New Pit Photos (GPS time/date enabled)
    <br>
    <small style="color: #666;">
      Capture photos showing before and after pit installation
    </small>
  </label>
  <input 
    type="file" 
    id="pit-new-p9-progress-photos" 
    name="pit_new_p9_progress_photos[]"
    accept="image/*"
    multiple
    capture="environment"
    style="margin-top: 10px; width: calc(100% - 20px); padding: 8px; border: 1px solid var(--dark-20); border-radius: 0.5rem; font-size: 1rem; font-family: 'Exo', sans-serif; background-color: white;"
  >
  <p style="font-size: 0.9em; color: #555; margin-top: 8px;">
    You can select multiple photos or take new ones with your camera (enable GPS for time/date stamp).
  </p>
</div>
          </div>

          <!-- Replaced Pits -->
          <div>
            <input type="checkbox" id="discipline-pit-replaced-progress" name="pit-type[]" value="pit-replaced-progress" onchange="toggleDisciplineFields(this)" />
            <label for="discipline-pit-replaced-progress">Replaced With</label>
          </div>

          <div id="discipline-pit-replaced-progress-fields" class="discipline-conditional-fields" style="display: none;">
            
            <!-- C8 Size -->
            <div>
              <input type="checkbox" id="discipline-pit-replaced-c8-progress" name="pit-replaced-size[]" value="pit-replaced-c8-progress" onchange="toggleDisciplineFields(this)" />
              <label for="discipline-pit-replaced-c8-progress">C8</label>
            </div>

            <div id="discipline-pit-replaced-c8-progress-fields" class="discipline-conditional-fields" style="display: none;">
              <label for="pit-replaced-c8-progress-qty">Quantity:</label>
              <input type="number" id="pit-replaced-c8-progress-qty" name="pit-replaced-c8-progress-qty" min="0" step="1" />

  <label for="pit-replaced-c8-progress-photos" style="margin-top: 15px;">
    Replaced Pit Photos (GPS time/date enabled)
    <br>
    <small style="color: #666;">
      Capture photos showing before and after pit installation
    </small>
  </label>
  <input 
    type="file" 
    id="pit-replaced-c8-progress-photos" 
    name="pit_replaced_c8_progress_photos[]"
    accept="image/*"
    multiple
    capture="environment"
    style="margin-top: 10px; width: calc(100% - 20px); padding: 8px; border: 1px solid var(--dark-20); border-radius: 0.5rem; font-size: 1rem; font-family: 'Exo', sans-serif; background-color: white;"
  >
  <p style="font-size: 0.9em; color: #555; margin-top: 8px;">
    You can select multiple photos or take new ones with your camera (enable GPS for time/date stamp).
  </p>
</div>

            <!-- C9 Size -->
            <div>
              <input type="checkbox" id="discipline-pit-replaced-c9-progress" name="pit-replaced-size[]" value="pit-replaced-c9-progress" onchange="toggleDisciplineFields(this)" />
              <label for="discipline-pit-replaced-c9-progress">C9</label>
            </div>

            <div id="discipline-pit-replaced-c9-progress-fields" class="discipline-conditional-fields" style="display: none;">
              <label for="pit-replaced-c9-progress-qty">Quantity:</label>
              <input type="number" id="pit-replaced-c9-progress-qty" name="pit-replaced-c9-progress-qty" min="0" step="1" />

  <label for="pit-replaced-c9-progress-photos" style="margin-top: 15px;">
    Replaced Pit Photos (GPS time/date enabled)
    <br>
    <small style="color: #666;">
      Capture photos showing before and after pit installation
    </small>
  </label>
  <input 
    type="file" 
    id="pit-replaced-c9-progress-photos" 
    name="pit_replaced_c9_progress_photos[]"
    accept="image/*"
    multiple
    capture="environment"
    style="margin-top: 10px; width: calc(100% - 20px); padding: 8px; border: 1px solid var(--dark-20); border-radius: 0.5rem; font-size: 1rem; font-family: 'Exo', sans-serif; background-color: white;"
  >
  <p style="font-size: 0.9em; color: #555; margin-top: 8px;">
    You can select multiple photos or take new ones with your camera (enable GPS for time/date stamp).
    </p>
</div>

            <!-- Manhole Size -->
            <div>
              <input type="checkbox" id="discipline-pit-replaced-manhole-progress" name="pit-replaced-size[]" value="pit-replaced-manhole-progress" onchange="toggleDisciplineFields(this)" />
              <label for="discipline-pit-replaced-manhole-progress">Manhole</label>
            </div>

            <div id="discipline-pit-replaced-manhole-progress-fields" class="discipline-conditional-fields" style="display: none;">
              <label for="pit-replaced-manhole-progress-qty">Quantity:</label>
              <input type="number" id="pit-replaced-manhole-progress-qty" name="pit-replaced-manhole-progress-qty" min="0" step="1" />

  <label for="pit-replaced-manhole-progress-photos" style="margin-top: 15px;">
    Replaced Manhole Photos (GPS time/date enabled)
    <br>
    <small style="color: #666;">
      Capture photos showing before and after manhole installation
    </small>
  </label>
  <input 
    type="file" 
    id="pit-replaced-manhole-progress-photos" 
    name="pit_replaced_manhole_progress_photos[]"
    accept="image/*"
    multiple
    capture="environment"
    style="margin-top: 10px; width: calc(100% - 20px); padding: 8px; border: 1px solid var(--dark-20); border-radius: 0.5rem; font-size: 1rem; font-family: 'Exo', sans-serif; background-color: white;"
  >
  <p style="font-size: 0.9em; color: #555; margin-top: 8px;">
    You can select multiple photos or take new ones with your camera (enable GPS for time/date stamp).
    </p>
</div>

            <!-- P5 Size -->
            <div>
              <input type="checkbox" id="discipline-pit-replaced-p5-progress" name="pit-replaced-size[]" value="pit-replaced-p5-progress" onchange="toggleDisciplineFields(this)" />
              <label for="discipline-pit-replaced-p5-progress">P5</label>
            </div>

            <div id="discipline-pit-replaced-p5-progress-fields" class="discipline-conditional-fields" style="display: none;">
              <label for="pit-replaced-p5-progress-qty">Quantity:</label>
              <input type="number" id="pit-replaced-p5-progress-qty" name="pit-replaced-p5-progress-qty" min="0" step="1" />

  <label for="pit-replaced-p5-progress-photos" style="margin-top: 15px;">
    Replaced Pit Photos (GPS time/date enabled)
    <br>
    <small style="color: #666;">
      Capture photos showing before and after pit installation
    </small>
  </label>
  <input 
    type="file" 
    id="pit-replaced-p5-progress-photos" 
    name="pit_replaced_p5_progress_photos[]"
    accept="image/*"
    multiple
    capture="environment"
    style="margin-top: 10px; width: calc(100% - 20px); padding: 8px; border: 1px solid var(--dark-20); border-radius: 0.5rem; font-size: 1rem; font-family: 'Exo', sans-serif; background-color: white;"
  >
  <p style="font-size: 0.9em; color: #555; margin-top: 8px;">
    You can select multiple photos or take new ones with your camera (enable GPS for time/date stamp).
    </p>
</div>

            <!-- P6 Size -->
            <div>
              <input type="checkbox" id="discipline-pit-replaced-p6-progress" name="pit-replaced-size[]" value="pit-replaced-p6-progress" onchange="toggleDisciplineFields(this)" />
              <label for="discipline-pit-replaced-p6-progress">P6</label>
            </div>

            <div id="discipline-pit-replaced-p6-progress-fields" class="discipline-conditional-fields" style="display: none;">
              <label for="pit-replaced-p6-progress-qty">Quantity:</label>
              <input type="number" id="pit-replaced-p6-progress-qty" name="pit-replaced-p6-progress-qty" min="0" step="1" />

  <label for="pit-replaced-p6-progress-photos" style="margin-top: 15px;">
    Replaced Pit Photos (GPS time/date enabled)
    <br>
    <small style="color: #666;">
      Capture photos showing before and after pit installation
    </small>
  </label>
  <input 
    type="file" 
    id="pit-replaced-p6-progress-photos" 
    name="pit_replaced_p6_progress_photos[]"
    accept="image/*"
    multiple
    capture="environment"
    style="margin-top: 10px; width: calc(100% - 20px); padding: 8px; border: 1px solid var(--dark-20); border-radius: 0.5rem; font-size: 1rem; font-family: 'Exo', sans-serif; background-color: white;"
  >
  <p style="font-size: 0.9em; color: #555; margin-top: 8px;">
    You can select multiple photos or take new ones with your camera (enable GPS for time/date stamp).
    </p>
</div>

            <!-- P8 Size -->
            <div>
              <input type="checkbox" id="discipline-pit-replaced-p8-progress" name="pit-replaced-size[]" value="pit-replaced-p8-progress" onchange="toggleDisciplineFields(this)" />
              <label for="discipline-pit-replaced-p8-progress">P8</label>
            </div>

            <div id="discipline-pit-replaced-p8-progress-fields" class="discipline-conditional-fields" style="display: none;">
              <label for="pit-replaced-p8-progress-qty">Quantity:</label>
              <input type="number" id="pit-replaced-p8-progress-qty" name="pit-replaced-p8-progress-qty" min="0" step="1" />

  <label for="pit-replaced-p8-progress-photos" style="margin-top: 15px;">
    Replaced Pit Photos (GPS time/date enabled)
    <br>
    <small style="color: #666;">
      Capture photos showing before and after pit installation
    </small>
  </label>
  <input 
    type="file" 
    id="pit-replaced-p8-progress-photos" 
    name="pit_replaced_p8_progress_photos[]"
    accept="image/*"
    multiple
    capture="environment"
    style="margin-top: 10px; width: calc(100% - 20px); padding: 8px; border: 1px solid var(--dark-20); border-radius: 0.5rem; font-size: 1rem; font-family: 'Exo', sans-serif; background-color: white;"
  >
  <p style="font-size: 0.9em; color: #555; margin-top: 8px;">
    You can select multiple photos or take new ones with your camera (enable GPS for time/date stamp).
    </p>
</div>

            <!-- P9 Size -->
            <div>
              <input type="checkbox" id="discipline-pit-replaced-p9-progress" name="pit-replaced-size[]" value="pit-replaced-p9-progress" onchange="toggleDisciplineFields(this)" />
              <label for="discipline-pit-replaced-p9-progress">P9</label>
            </div>

            <div id="discipline-pit-replaced-p9-progress-fields" class="discipline-conditional-fields" style="display: none;">
              <label for="pit-replaced-p9-progress-qty">Quantity:</label>
              <input type="number" id="pit-replaced-p9-progress-qty" name="pit-replaced-p9-progress-qty" min="0" step="1" />

  <label for="pit-replaced-p9-progress-photos" style="margin-top: 15px;">
    Replaced Pit Photos (GPS time/date enabled)
    <br>
    <small style="color: #666;">
      Capture photos showing before and after pit installation
    </small>
  </label>
  <input 
    type="file" 
    id="pit-replaced-p9-progress-photos" 
    name="pit_replaced_p9_progress_photos[]"
    accept="image/*"
    multiple
    capture="environment"
    style="margin-top: 10px; width: calc(100% - 20px); padding: 8px; border: 1px solid var(--dark-20); border-radius: 0.5rem; font-size: 1rem; font-family: 'Exo', sans-serif; background-color: white;"
  >
  <p style="font-size: 0.9em; color: #555; margin-top: 8px;">
    You can select multiple photos or take new ones with your camera (enable GPS for time/date stamp).
    </p>
</div>
          </div>
        </div>

        <!-- Marker Posts - Progress -->
        <div>
          <input type="checkbox" id="discipline-markers-progress" name="discipline[]" value="markers-progress" onchange="toggleDisciplineFields(this)" />
          <label for="discipline-markers-progress">Marker Posts</label>
        </div>

        <div id="discipline-markers-progress-fields" class="discipline-conditional-fields" style="display: none;">
          <label for="markers-progress-qty">Number Installed:</label>
          <input type="number" id="markers-progress-qty" name="markers-progress-qty" min="0" step="1" />

  <label for="markers-progress-photos" style="margin-top: 15px;">
    Marker Post installations (GPS time/date enabled)
    <br>
    <small style="color: #666;">
      Capture photos showing before and after marker post installs
    </small>
  </label>
  <input 
    type="file" 
    id="markers-progress-photos" 
    name="markers_progress_photos[]"
    accept="image/*"
    multiple
    capture="environment"
    style="margin-top: 10px; width: calc(100% - 20px); padding: 8px; border: 1px solid var(--dark-20); border-radius: 0.5rem; font-size: 1rem; font-family: 'Exo', sans-serif; background-color: white;"
  >
  <p style="font-size: 0.9em; color: #555; margin-top: 8px;">
    You can select multiple photos or take new ones with your camera (enable GPS for time/date stamp).
    </p>
</div>
      </div>
    </fieldset>

    <label for="progress-comments">Additional Comments? Escalate SHEQ concerns to your Genus FCM/Supervisor or SHEQ Advisor</label>
    <textarea id="progress-comments" name="progress-comments" placeholder="Track required actions in MyOsh with SHEQ support"></textarea>

    <div class="form-footer">
      <button type="button" class="btn-back" onclick="confirmReset('progress')">Back</button>
      <button type="submit">Submit Progress Register</button>
    </div>
  </form>
</div>
</main>

<script>
// ============================================================
// GLOBAL FUNCTIONS - Mob/Demob State Management
// ============================================================

let autocomplete; // Global variable for Google Maps autocomplete

function insertAfter(newNode, referenceNode) {
  referenceNode.parentNode.insertBefore(newNode, referenceNode.nextSibling);
}

function updateMobDemobState() {
  const mobCheckbox = document.getElementById("bog-mob");
  const demobCheckbox = document.getElementById("bog-demob");
  if (!mobCheckbox || !demobCheckbox) return;
  
  const isMob = mobCheckbox.checked;
  const isDemob = demobCheckbox.checked;

  if (isMob && isDemob) {
    mobCheckbox.checked = false;
    demobCheckbox.checked = false;
    return updateMobDemobState();
  }

  const conditionalIds = [
    "bog-estimated-start-time", "bog-estimated-finish-time", "bog-site-contact",
    "bog-onsite-crew-lead-mobile", "bog-onsite-crew-lead-email", "bog-Genus-FCM",
    "bog-ACM", "bog-acm-yes", "bog-guards", "bog-excavation",
    "bog-jha-uploaded", "bog-jha-photos", "bog-site-photos"
  ];

  function hideById(id, hide) {
    const el = document.getElementById(id);
    const label = document.querySelector(`label[for="${id}"]`);
    if (el) {
      el.style.display = hide ? "none" : "";
      if (hide) {
        el.removeAttribute("required");
      } else if (["INPUT", "SELECT", "TEXTAREA"].includes(el.tagName) && id !== "bog-comments") {
        el.setAttribute("required", "required");
      }
    }
    if (label) label.style.display = hide ? "none" : "";
  }

  conditionalIds.forEach(id => hideById(id, isMob || isDemob));

  // Special handling for the hidden crew lead field
  const leadHidden = document.getElementById('bog-site-contact-hidden');
  if (leadHidden) {
    if (isMob || isDemob) {
      leadHidden.removeAttribute('required');
    } else {
      leadHidden.setAttribute('required', 'required');
    }
  }

  const swmsSection = document.getElementById("bog-swms-section");
  if (swmsSection) swmsSection.style.display = (isMob || isDemob) ? "none" : "";

  const swmsFieldset = document.getElementById("bog-swms-fieldset");
  if (swmsFieldset) swmsFieldset.style.display = (isMob || isDemob) ? "none" : "";

  // Hide the helper text paragraphs when Mobilisation/Demobilisation is selected
  const jhaPhotoLabel = document.querySelector('label[for="bog-jha-photos"]');
  if (jhaPhotoLabel) {
    const jhaHelpText = jhaPhotoLabel.parentElement.querySelector('p');
    if (jhaHelpText) jhaHelpText.style.display = (isMob || isDemob) ? "none" : "";
  }

  const sitePhotoLabel = document.querySelector('label[for="bog-site-photos"]');
  if (sitePhotoLabel) {
    const siteHelpText = sitePhotoLabel.parentElement.querySelector('p');
    if (siteHelpText) siteHelpText.style.display = (isMob || isDemob) ? "none" : "";
  }

  // Update labels based on mob/demob state
  const locationLabel = document.querySelector('label[for="bog-Location"]');
  const locationField = document.getElementById('bog-Location');
  const crewNumberLabel = document.querySelector('label[for="bog-Number-of-People-at-Location"]');

  if (isMob) {
    // Mobilisation mode
    if (locationLabel) locationLabel.textContent = "Departure Address";
    if (locationField) locationField.placeholder = "Enter in the address you and your crew have departed from";
    if (crewNumberLabel) crewNumberLabel.textContent = "Number of people mobilising today for this discipline";
    
    // Initialize Google Maps autocomplete for mobilisation
    if (locationField && typeof google !== 'undefined') {
      autocomplete = new google.maps.places.Autocomplete(locationField, {
        componentRestrictions: { country: 'au' }
      });
    }
  } else if (isDemob) {
    // Demobilisation mode
    if (locationLabel) locationLabel.textContent = "Location";
    if (locationField) locationField.placeholder = "Enter sheet number and grid reference";
    if (crewNumberLabel) crewNumberLabel.textContent = "Number of people de-mobilising today for this discipline";
    
    // Remove autocomplete for demobilisation
    if (autocomplete) {
      google.maps.event.clearInstanceListeners(locationField);
      autocomplete = null;
    }
  } else {
    // Normal mode
    if (locationLabel) locationLabel.textContent = "Location";
    if (locationField) locationField.placeholder = "Enter sheet number and grid reference";
    if (crewNumberLabel) crewNumberLabel.textContent = "Number of People in Crew at Location";
    
    // Remove autocomplete for normal mode
    if (autocomplete) {
      google.maps.event.clearInstanceListeners(locationField);
      autocomplete = null;
    }
  }

  // Handle dynamic vehicle fields
  const crewVehiclesFieldId = "bog-crew-vehicles";
  const crewVehiclesLabelId = "label-bog-crew-vehicles";
  const heavyVehiclesFieldId = "bog-heavy-vehicles";
  const heavyVehiclesLabelId = "label-bog-heavy-vehicles";

  // Remove old fields if they exist
  [crewVehiclesLabelId, crewVehiclesFieldId, heavyVehiclesLabelId, heavyVehiclesFieldId].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.remove();
  });

  // Add vehicle fields for mob/demob
  if (isMob || isDemob) {
    const crewNamesHidden = document.getElementById('bog-crews-names-hidden');
    
    const vehicleLabelText = isMob
      ? "Number of crew vehicles being mobilised"
      : "Number of crew vehicles being de-mobilised";

    const heavyVehicleLabelText = isMob
      ? "Number of heavy vehicles being mobilised"
      : "Number of heavy vehicles being de-mobilised";

    // Create Heavy Vehicles field
    const heavyLabel = document.createElement("label");
    heavyLabel.id = heavyVehiclesLabelId;
    heavyLabel.htmlFor = heavyVehiclesFieldId;
    heavyLabel.textContent = heavyVehicleLabelText;

    const heavyInput = document.createElement("input");
    heavyInput.type = "number";
    heavyInput.id = heavyVehiclesFieldId;
    heavyInput.name = "Number of heavy vehicles";
    heavyInput.step = "1";
    heavyInput.min = "0";
    heavyInput.required = true;
    heavyInput.style.width = "100%";
    heavyInput.style.padding = "0.75rem";
    heavyInput.style.border = "1px solid var(--dark-20)";
    heavyInput.style.borderRadius = "0.5rem";
    heavyInput.style.fontSize = "1rem";
    heavyInput.style.fontFamily = "'Exo', sans-serif";

    insertAfter(heavyLabel, crewNamesHidden);
    insertAfter(heavyInput, heavyLabel);

    // Create Crew Vehicles field
    const crewLabel = document.createElement("label");
    crewLabel.id = crewVehiclesLabelId;
    crewLabel.htmlFor = crewVehiclesFieldId;
    crewLabel.textContent = vehicleLabelText;
    crewLabel.style.display = "block";
    crewLabel.style.margin = "1rem 0 0.5rem";
    crewLabel.style.fontWeight = "600";

    const crewInput = document.createElement("input");
    crewInput.type = "number";
    crewInput.id = crewVehiclesFieldId;
    crewInput.name = "Number of Crew vehicles";
    crewInput.step = "1";
    crewInput.min = "0";
    crewInput.required = true;
    crewInput.style.width = "100%";
    crewInput.style.padding = "0.75rem";
    crewInput.style.border = "1px solid var(--dark-20)";
    crewInput.style.borderRadius = "0.5rem";
    crewInput.style.fontSize = "1rem";
    crewInput.style.fontFamily = "'Exo', sans-serif";

    insertAfter(crewLabel, heavyInput);
    insertAfter(crewInput, crewLabel);
  }
}

// ============================================================
// UTILITY FUNCTIONS
// ============================================================

function confirmReset(formType) {
  if (confirm("Are you sure you want to reset this form and return to the form selection screen?")) {
    location.reload();
  }
}

function toggleDisciplineFields(checkbox) {
  const discipline = checkbox.value.toLowerCase().replace(/\s/g, '-').replace(/--+/g, '-');
  const fieldsDiv = document.getElementById(`discipline-${discipline}-fields`);
  
  if (fieldsDiv) {
    if (checkbox.checked) {
      fieldsDiv.style.display = 'block';
      const crewsInput = document.getElementById(`${discipline}-crews`);
      if (crewsInput && crewsInput.value === '') {
        crewsInput.value = '1';
      }
    } else {
      fieldsDiv.style.display = 'none';
      const crewsInput = document.getElementById(`${discipline}-crews`);
      if (crewsInput) crewsInput.value = '';
      const qtyInput = document.getElementById(`${discipline}-qty`);
      if (qtyInput) qtyInput.value = '';
      const subCheckboxes = fieldsDiv.querySelectorAll('input[type="checkbox"]');
      subCheckboxes.forEach(sub => {
        if (sub.checked) {
          sub.checked = false;
          toggleDisciplineFields(sub);
        }
      });
      const numberInputs = fieldsDiv.querySelectorAll('input[type="number"]');
      numberInputs.forEach(input => input.value = '');
      const daysCheckboxes = fieldsDiv.querySelectorAll(`input[name="${discipline}-days[]"]`);
      daysCheckboxes.forEach(day => day.checked = false);
      const daysError = document.getElementById(`${discipline}-days-error`);
      if (daysError) daysError.style.display = 'none';
    }
  }
}

function toggleACMField() {
  const select = document.getElementById("bog-ACM");
  const acmField = document.getElementById("bog-acm-notification-field");
  const acmYes = document.getElementById("bog-acm-yes");

  if (select?.value === "Yes") {
    acmField.style.display = "block";
    acmYes.setAttribute("required", "required");
  } else {
    acmField.style.display = "none";
    acmYes.removeAttribute("required");
  }
}

// ============================================================
// DATE & TIME FUNCTIONS
// ============================================================

function setDefaultDate() {
  const now = new Date();
  const perthTime = new Date(now.toLocaleString("en-US", { timeZone: "Australia/Perth" }));
  const year = perthTime.getFullYear();
  const month = String(perthTime.getMonth() + 1).padStart(2, '0');
  const day = String(perthTime.getDate()).padStart(2, '0');
  const todayString = `${year}-${month}-${day}`;
  
  const bogDate = document.getElementById('bog-date');
  if (bogDate) bogDate.value = todayString;

  const progressDate = document.getElementById('progress-date');
  if (progressDate) progressDate.value = todayString;
}

function generateTimeOptions(selectId) {
  const select = document.getElementById(selectId);
  if (!select) return;

  for (let hour = 0; hour < 24; hour++) {
    for (let min = 0; min < 60; min += 30) {
      const hourStr = hour.toString().padStart(2, '0');
      const minStr = min.toString().padStart(2, '0');
      const time24 = `${hourStr}:${minStr}`;

      let displayHour = hour % 12;
      displayHour = displayHour === 0 ? 12 : displayHour;
      const ampm = hour < 12 ? 'AM' : 'PM';
      const displayStr = `${displayHour}:${minStr} ${ampm}`;

      const option = document.createElement('option');
      option.value = time24;
      option.textContent = displayStr;
      select.appendChild(option);
    }
  }
}

function updateBogTimestamps() {
  const date = document.getElementById('bog-date')?.value;
  const start = document.getElementById('bog-estimated-start-time')?.value;
  const finish = document.getElementById('bog-estimated-finish-time')?.value;

  if (date && start && finish) {
    document.getElementById('bog-estimated-start-timestamp').value = `${date}T${start}:00`;
    document.getElementById('bog-estimated-finish-timestamp').value = `${date}T${finish}:00`;
  }
}

// ============================================================
// VALIDATION FUNCTIONS
// ============================================================

function validateSWMS() {
  const checked = document.querySelectorAll('input[name="bog-SWMS[]"]:checked');
  const errorEl = document.getElementById('swms-error');
  
  if (checked.length === 0) {
    if (errorEl) errorEl.style.display = 'block';
    return false;
  }
  
  if (errorEl) errorEl.style.display = 'none';
  return true;
}

function validateBogForm() {
  const form = document.querySelector('#bog-form');
  const isValid = form.checkValidity();
  
  const isMob = document.getElementById('bog-mob').checked;
  const isDemob = document.getElementById('bog-demob').checked;
  const swmsValid = (isMob || isDemob) ? true : validateSWMS();
  
  if (!isValid || !swmsValid) {
    showErrorMessage();
    form.reportValidity();
    return false;
  }
  return true;
}

function validateProgressForm() {
  const form = document.getElementById('progress-form');
  if (!form.checkValidity()) {
    showErrorMessage();
    form.reportValidity();
    return false;
  }
  return true;
}

// ============================================================
// UI MESSAGE FUNCTIONS
// ============================================================

function showErrorMessage() {
  const box = document.getElementById('thank-you-message');
  const title = document.getElementById('message-title');
  const body = document.getElementById('message-body');
  title.textContent = '';
  body.textContent = 'Please review your submission and ensure all fields are completed.';
  body.style.color = 'red';
  box.style.display = 'block';
}

function showSuccessMessage() {
  const box = document.getElementById('thank-you-message');
  const title = document.getElementById('message-title');
  const body = document.getElementById('message-body');
  title.textContent = 'Thank you!';
  body.innerHTML = 'Your form has been submitted successfully.<br><br><button type="button" class="btn-back" onclick="returnToFormSwitcher()">Submit Another Form</button><br><small>You will be redirected to form selection in 5 seconds...</small>';
  body.style.color = '';
  box.style.display = 'block';
  
  setTimeout(() => {
    returnToFormSwitcher();
    box.style.display = 'none';
  }, 5000);
}

function returnToFormSwitcher() {
  location.reload();
}

function showForm(formType) {
  document.getElementById('thank-you-message').style.display = 'none';

  ['form-bog', 'form-progress'].forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      el.classList.add('hidden');
      el.style.display = 'none';
    }
  });

  const target = document.getElementById(`form-${formType}`);
  if (target) {
    target.classList.remove('hidden');
    target.style.display = 'block';
  }

  setDefaultDate();

  ['btn-bog', 'btn-progress'].forEach(id => {
    const btn = document.getElementById(id);
    if (btn) {
      if (id === `btn-${formType}`) {
        btn.classList.add('active');
        btn.style.display = 'inline-block';
      } else {
        btn.classList.remove('active');
        btn.style.display = 'none';
      }
    }
  });
}

// ============================================================
// AIRTABLE CONFIGURATION & FUNCTIONS
// ============================================================

const AIRTABLE_CONFIG = {
  bog: {
    baseId: 'appShjxvRISfybCBh',
    tableId: 'BOG',
    apiKey: 'patVqRGBoFq3KitRq.eb7e0b3d1bfb79012bdd2e2ea39e0cf3ebf73adc748d9311714d5c6863fa21cd'
  },
  progress: {
    baseId: 'appShjxvRISfybCBh',
    tableId: 'Progress Register',
    apiKey: 'patVqRGBoFq3KitRq.eb7e0b3d1bfb79012bdd2e2ea39e0cf3ebf73adc748d9311714d5c6863fa21cd'
  },
  progressRegister: {
    baseId: 'appShjxvRISfybCBh',
    tableId: 'Progress Register',
    apiKey: 'patVqRGBoFq3KitRq.eb7e0b3d1bfb79012bdd2e2ea39e0cf3ebf73adc748d9311714d5c6863fa21cd'
  },
  progressActivities: {
    baseId: 'appShjxvRISfybCBh',
    tableId: 'Progress Activities',
    apiKey: 'patVqRGBoFq3KitRq.eb7e0b3d1bfb79012bdd2e2ea39e0cf3ebf73adc748d9311714d5c6863fa21cd'
  }
};

async function submitToAirtable(formType, formData) {
  const cfg = AIRTABLE_CONFIG[formType];
  if (!cfg) throw new Error(`Missing config for ${formType}`);

  const url = `https://api.airtable.com/v0/${cfg.baseId}/${cfg.tableId}`;

  const res = await fetch(url, {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${cfg.apiKey}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      records: [{ fields: formData }],
      typecast: true
    })
  });

  if (!res.ok) {
    const err = await res.json().catch(() => ({}));
    throw new Error(err.error?.message || `Airtable error ${res.status}`);
  }

  return res;
}

const PRESIGN_WORKER_URL = "https://bog-r2-presign.richard-ociepa.workers.dev";

async function uploadFilesToAirtable(files, formType, fieldName = 'Photos') {
    if (!files?.length) return [];

    console.log(`Uploading ${files.length} file(s) for ${fieldName}`);

    const attachments = [];

    for (const file of files) {
        try {
            // Create FormData with the file
            const formData = new FormData();
            formData.append('file', file);
            formData.append('filename', file.name);

            // Upload directly to Worker
            const uploadRes = await fetch(PRESIGN_WORKER_URL, {
                method: 'POST',
                body: formData
            });

            if (!uploadRes.ok) {
                const errorText = await uploadRes.text();
                throw new Error(`Upload failed: ${uploadRes.status} - ${errorText}`);
            }

            const result = await uploadRes.json();

            // Airtable only accepts {url: "..."} format for attachments
            attachments.push({
                url: result.url
            });

            console.log(`Uploaded ${file.name} â†’ ${result.url}`);

        } catch (err) {
            console.error(`Failed ${file.name} (${fieldName}):`, err);
        }
    }

    return attachments;
}

// ============================================================
// CREW MANAGEMENT FUNCTIONS
// ============================================================

const webAppUrl = "https://script.google.com/macros/s/AKfycbzoQIg5QnJ8Kd6ZQxv_oV7b90uf9cQXv047HukJsfBL7DgzM-X26RUQKuxNnqB8MA_Mxg/exec";

const sections = [
  { crew: "bog-crews-names", lead: "bog-site-contact", multiCrew: true, companyField: "bog-company-name" },
  { lead: "progress-site-contact", companyField: "progress-company-name" }
];

async function fetchCrewNames(company) {
  if (!company) return [];
  try {
    const url = `https://corsproxy.io/?${encodeURIComponent(webAppUrl + '?company=' + encodeURIComponent(company))}`;
    const res = await fetch(url);
    return await res.json();
  } catch (err) {
    console.error("Failed to fetch crew names:", err);
    return [];
  }
}

function createRadioList(containerEl, hiddenInput, crewList) {
  containerEl.innerHTML = "";
  crewList.forEach(name => {
    const label = document.createElement("label");
    label.style.display = "block";
    const radio = document.createElement("input");
    radio.type = "radio";
    radio.name = containerEl.id + "-radio";
    radio.value = name;
    radio.addEventListener("change", () => hiddenInput.value = name);
    label.appendChild(radio);
    label.appendChild(document.createTextNode(name));
    containerEl.appendChild(label);
  });
}

function createCheckboxList(containerEl, hiddenInput, crewList) {
  containerEl.innerHTML = "";
  crewList.forEach(name => {
    const label = document.createElement("label");
    label.style.display = "block";
    const checkbox = document.createElement("input");
    checkbox.type = "checkbox";
    checkbox.value = name;
    checkbox.addEventListener("change", () => {
      const selected = Array.from(containerEl.querySelectorAll("input[type=checkbox]:checked")).map(cb => cb.value);
      hiddenInput.value = selected.join(", ");
    });
    label.appendChild(checkbox);
    label.appendChild(document.createTextNode(name));
    containerEl.appendChild(label);
  });
}

async function initSections() {
  for (const section of sections) {
    const hiddenLead = section.lead ? document.getElementById(section.lead + "-hidden") : null;
    const leadEl = section.lead ? document.getElementById(section.lead) : null;
    const hiddenCrew = section.crew ? document.getElementById(section.crew + "-hidden") : null;
    const crewEl = section.crew ? document.getElementById(section.crew) : null;

    let companyName = section.companyField ? document.getElementById(section.companyField)?.value : "Genus Services";

    const crewList = await fetchCrewNames(companyName);

    if (crewEl && hiddenCrew && section.multiCrew) {
      createCheckboxList(crewEl, hiddenCrew, crewList);
    }

    if (leadEl && hiddenLead) {
      createRadioList(leadEl, hiddenLead, crewList);
    }

    if (section.companyField) {
      const companyEl = document.getElementById(section.companyField);
      if (companyEl) {
        companyEl.addEventListener("change", async () => {
          const updatedList = await fetchCrewNames(companyEl.value);
          if (crewEl && hiddenCrew && section.multiCrew) createCheckboxList(crewEl, hiddenCrew, updatedList);
          if (leadEl && hiddenLead) createRadioList(leadEl, hiddenLead, updatedList);
        });
      }
    }
  }
}

// ============================================================
// GOOGLE MAPS CALLBACK
// ============================================================

function initAutocomplete() {
  console.log('Google Maps API loaded successfully');
}

// ============================================================
// MAIN INITIALIZATION
// ============================================================

document.addEventListener('DOMContentLoaded', function () {
  setDefaultDate();

  // Generate time dropdowns
  generateTimeOptions('bog-estimated-start-time');
  generateTimeOptions('bog-estimated-finish-time');

  // Timestamp listeners
  ['bog-estimated-start-time', 'bog-estimated-finish-time', 'bog-date'].forEach(id => {
    document.getElementById(id)?.addEventListener('change', updateBogTimestamps);
  });
  document.getElementById('bog-form')?.addEventListener('submit', updateBogTimestamps);

  // Mob / Demob logic
  const mob = document.getElementById("bog-mob");
  const demob = document.getElementById("bog-demob");
  if (mob && demob) {
    mob.addEventListener("change", () => {
      if (mob.checked) demob.checked = false;
      updateMobDemobState();
    });
    demob.addEventListener("change", () => {
      if (demob.checked) mob.checked = false;
      updateMobDemobState();
    });
    updateMobDemobState();
  }

  // Initialize crew sections
  initSections();

  // BOG form submit
  document.getElementById('bog-form')?.addEventListener('submit', async function(e) {
    e.preventDefault();
    if (!validateBogForm()) return;

    const btn = this.querySelector('button[type="submit"]');
    btn.disabled = true;
    btn.textContent = 'Processing...';

    try {
      const swms = Array.from(document.querySelectorAll('input[name="bog-SWMS[]"]:checked'))
        .map(el => el.value);

      let data = {
        "Project": document.getElementById('bog-project')?.value || "Kalgoorlie - Wallaroo",
        "Form Date": document.getElementById('bog-date')?.value || "",
        "Is Mobilisation Day": document.getElementById('bog-mob')?.checked || false,
        "Is Demobilisation Day": document.getElementById('bog-demob')?.checked || false,
        "Company Name": document.getElementById('bog-company-name')?.value || "",
        "Discipline": document.getElementById('bog-discipline')?.value || "",
        "Estimated Start Time2": document.getElementById('bog-estimated-start-timestamp')?.value || "",
        "Estimated Finish Time2": document.getElementById('bog-estimated-finish-timestamp')?.value || "",
        "Location / Grid Reference": document.getElementById('bog-Location')?.value || "",
        "Onsite Crew Lead Name": document.getElementById('bog-site-contact-hidden')?.value || "",
        "Onsite Crew Lead Mobile2": document.getElementById('bog-onsite-crew-lead-mobile')?.value || "",
        "Onsite Crew Lead Email": document.getElementById('bog-onsite-crew-lead-email')?.value || "",
        "Number of People at Location": Number(document.getElementById('bog-Number-of-People-at-Location')?.value) || 0,
        "Selected Crew Members": document.getElementById('bog-crews-names-hidden')?.value || "",
        "Genus FCM": document.getElementById('bog-Genus-FCM')?.value || "",
        "SWMS Selected": swms,
        "JHA Signed & Inducted": document.getElementById('bog-jha-uploaded')?.checked || false,
        "ACM Disturbance Planned?": document.getElementById('bog-ACM')?.value || "",
        "ACM Notification Received & on JHA": document.getElementById('bog-acm-yes')?.value === "Yes",
        "Gas Monitoring & Trench Guards in Place": document.getElementById('bog-guards-checkbox')?.checked || false,
        "Excavation Work Today": document.getElementById('bog-excavation-checkbox')?.checked || false,
        "Additional Comments": document.getElementById('bog-comments')?.value || "",
        'Number of Crew vehicles': document.getElementById('bog-crew-vehicles')?.value || '',
        'Number of heavy vehicles': document.getElementById('bog-heavy-vehicles')?.value || ''
      };

      btn.textContent = 'Uploading JHA photos...';
      const jhaAtt = await uploadFilesToAirtable(
        document.getElementById('bog-jha-photos')?.files || [],
        'bog',
        'JHA Photos'
      );
      if (jhaAtt.length) data['JHA Photos'] = jhaAtt;

      btn.textContent = 'Uploading site photos...';
      const siteAtt = await uploadFilesToAirtable(
        document.getElementById('bog-site-photos')?.files || [],
        'bog',
        'Site Setup Photos'
      );
      if (siteAtt.length) data['Site Setup Photos'] = siteAtt;

      btn.textContent = 'Submitting...';
      await submitToAirtable('bog', data);

      showSuccessMessage();

    } catch (err) {
      console.error('BOG submission failed:', err);
      alert('Submission failed: ' + err.message);
    } finally {
      btn.disabled = false;
      btn.textContent = 'Submit BOG';
    }
  });

  // Progress form submit
document.getElementById('progress-form')?.addEventListener('submit', async function(e) {
  e.preventDefault();
  if (!validateProgressForm()) return;

  const btn = this.querySelector('button[type="submit"]');
  btn.disabled = true;
  btn.textContent = 'Processing...';

  try {
    // Collect common submission data (used for all activity records)
    const commonData = {
      "Project": document.getElementById('progress-project')?.value || "Kalgoorlie - Wallaroo",
      "Form Date": document.getElementById('progress-date')?.value || "",
      "Company Name": document.getElementById('progress-company-name')?.value || "",
      "Onsite Crew Lead Name": document.getElementById('progress-site-contact-hidden')?.value || "",
      "Onsite Crew Lead Mobile2": document.getElementById('progress-onsite-crew-lead-mobile')?.value || "",
      "Location / Grid Reference": document.getElementById('progress-Location')?.value || "",
      "Additional Comments": document.getElementById('progress-comments')?.value || ""
    };

    // Collect all activities with their complete data
    const activities = [];

    // Plough
    if (document.getElementById('discipline-plough-progress')?.checked) {
      btn.textContent = 'Uploading Plough photos...';
      const photos = await uploadFilesToAirtable(
        document.getElementById('plough-progress-cable-marking-photos')?.files || [],
        'progressRegister',
        'Plough Photos'
      );
      activities.push({
        ...commonData,
        "Activity": "Plough",
        "Quantity/Metres": Number(document.getElementById('plough-progress-qty')?.value) || 0,
        "Activity Photos": photos
      });
    }

    // Bore PE63
    if (document.getElementById('discipline-bore-pe63-progress')?.checked) {
      btn.textContent = 'Uploading Bore PE63 photos...';
      const photos = await uploadFilesToAirtable(
        document.getElementById('bore-pe63-progress-photos')?.files || [],
        'progressRegister',
        'Bore PE63 Photos'
      );
      activities.push({
        ...commonData,
        "Activity": "Bore - PE63",
        "Quantity/Metres": Number(document.getElementById('bore-pe63-progress-qty')?.value) || 0,
        "Activity Photos": photos
      });
    }

    // Bore PE110
    if (document.getElementById('discipline-bore-pe110-progress')?.checked) {
      btn.textContent = 'Uploading Bore PE110 photos...';
      const photos = await uploadFilesToAirtable(
        document.getElementById('bore-pe110-progress-photos')?.files || [],
        'progressRegister',
        'Bore PE110 Photos'
      );
      activities.push({
        ...commonData,
        "Activity": "Bore - PE110",
        "Quantity/Metres": Number(document.getElementById('bore-pe110-progress-qty')?.value) || 0,
        "Activity Photos": photos
      });
    }

    // Trench P50
    if (document.getElementById('discipline-trench-p50-progress')?.checked) {
      btn.textContent = 'Uploading Trench P50 photos...';
      const photos = await uploadFilesToAirtable(
        document.getElementById('trench-p50-progress-photos')?.files || [],
        'progressRegister',
        'Trench P50 Photos'
      );
      activities.push({
        ...commonData,
        "Activity": "Trench - P50",
        "Quantity/Metres": Number(document.getElementById('trench-p50-progress-qty')?.value) || 0,
        "Activity Photos": photos
      });
    }

    // Trench P100
    if (document.getElementById('discipline-trench-p100-progress')?.checked) {
      btn.textContent = 'Uploading Trench P100 photos...';
      const photos = await uploadFilesToAirtable(
        document.getElementById('trench-p100-progress-photos')?.files || [],
        'progressRegister',
        'Trench P100 Photos'
      );
      activities.push({
        ...commonData,
        "Activity": "Trench - P100",
        "Quantity/Metres": Number(document.getElementById('trench-p100-progress-qty')?.value) || 0,
        "Activity Photos": photos
      });
    }

    // Hauling
    if (document.getElementById('discipline-hauling-progress')?.checked) {
      btn.textContent = 'Uploading Hauling photos...';
      const photos = await uploadFilesToAirtable(
        document.getElementById('hauling-progress-cable-marking-photos')?.files || [],
        'progressRegister',
        'Hauling Photos'
      );
      activities.push({
        ...commonData,
        "Activity": "Hauling",
        "Quantity/Metres": Number(document.getElementById('hauling-progress-qty')?.value) || 0,
        "Activity Photos": photos
      });
    }

    // RRP
    if (document.getElementById('discipline-rrp-progress')?.checked) {
      btn.textContent = 'Uploading RRP photos...';
      const photos = await uploadFilesToAirtable(
        document.getElementById('rrp-progress-tag-photos')?.files || [],
        'progressRegister',
        'RRP Photos'
      );
      activities.push({
        ...commonData,
        "Activity": "RRP (Rod, Rope & Prove)",
        "Quantity/Metres": Number(document.getElementById('rrp-progress-qty')?.value) || 0,
        "Activity Photos": photos
      });
    }

    // Blockages
    if (document.getElementById('discipline-blockages-progress')?.checked) {
      btn.textContent = 'Uploading Blockages photos...';
      const photos = await uploadFilesToAirtable(
        document.getElementById('blockages-progress-tag-photos')?.files || [],
        'progressRegister',
        'Blockages Photos'
      );
      activities.push({
        ...commonData,
        "Activity": "Blockages",
        "Quantity/Metres": Number(document.getElementById('blockages-progress-qty')?.value) || 0,
        "Activity Photos": photos
      });
    }

    // New Pits - C8
    if (document.getElementById('discipline-pit-new-c8-progress')?.checked) {
      btn.textContent = 'Uploading New Pit C8 photos...';
      const photos = await uploadFilesToAirtable(
        document.getElementById('pit-new-c8-progress-photos')?.files || [],
        'progressRegister',
        'New Pit C8 Photos'
      );
      activities.push({
        ...commonData,
        "Activity": "Pits - New - C8",
        "Quantity/Metres": Number(document.getElementById('pit-new-c8-progress-qty')?.value) || 0,
        "Activity Photos": photos
      });
    }

    // New Pits - C9
    if (document.getElementById('discipline-pit-new-c9-progress')?.checked) {
      btn.textContent = 'Uploading New Pit C9 photos...';
      const photos = await uploadFilesToAirtable(
        document.getElementById('pit-new-c9-progress-photos')?.files || [],
        'progressRegister',
        'New Pit C9 Photos'
      );
      activities.push({
        ...commonData,
        "Activity": "Pits - New - C9",
        "Quantity/Metres": Number(document.getElementById('pit-new-c9-progress-qty')?.value) || 0,
        "Activity Photos": photos
      });
    }

    // New Pits - Manhole
    if (document.getElementById('discipline-pit-new-manhole-progress')?.checked) {
      btn.textContent = 'Uploading New Manhole photos...';
      const photos = await uploadFilesToAirtable(
        document.getElementById('pit-new-manhole-progress-photos')?.files || [],
        'progressRegister',
        'New Manhole Photos'
      );
      activities.push({
        ...commonData,
        "Activity": "Pits - New - Manhole",
        "Quantity/Metres": Number(document.getElementById('pit-new-manhole-progress-qty')?.value) || 0,
        "Activity Photos": photos
      });
    }

    // New Pits - P5
    if (document.getElementById('discipline-pit-new-p5-progress')?.checked) {
      btn.textContent = 'Uploading New Pit P5 photos...';
      const photos = await uploadFilesToAirtable(
        document.getElementById('pit-new-p5-progress-photos')?.files || [],
        'progressRegister',
        'New Pit P5 Photos'
      );
      activities.push({
        ...commonData,
        "Activity": "Pits - New - P5",
        "Quantity/Metres": Number(document.getElementById('pit-new-p5-progress-qty')?.value) || 0,
        "Activity Photos": photos
      });
    }

    // New Pits - P6
    if (document.getElementById('discipline-pit-new-p6-progress')?.checked) {
      btn.textContent = 'Uploading New Pit P6 photos...';
      const photos = await uploadFilesToAirtable(
        document.getElementById('pit-new-p6-progress-photos')?.files || [],
        'progressRegister',
        'New Pit P6 Photos'
      );
      activities.push({
        ...commonData,
        "Activity": "Pits - New - P6",
        "Quantity/Metres": Number(document.getElementById('pit-new-p6-progress-qty')?.value) || 0,
        "Activity Photos": photos
      });
    }

    // New Pits - P8
    if (document.getElementById('discipline-pit-new-p8-progress')?.checked) {
      btn.textContent = 'Uploading New Pit P8 photos...';
      const photos = await uploadFilesToAirtable(
        document.getElementById('pit-new-p8-progress-photos')?.files || [],
        'progressRegister',
        'New Pit P8 Photos'
      );
      activities.push({
        ...commonData,
        "Activity": "Pits - New - P8",
        "Quantity/Metres": Number(document.getElementById('pit-new-p8-progress-qty')?.value) || 0,
        "Activity Photos": photos
      });
    }

    // New Pits - P9
    if (document.getElementById('discipline-pit-new-p9-progress')?.checked) {
      btn.textContent = 'Uploading New Pit P9 photos...';
      const photos = await uploadFilesToAirtable(
        document.getElementById('pit-new-p9-progress-photos')?.files || [],
        'progressRegister',
        'New Pit P9 Photos'
      );
      activities.push({
        ...commonData,
        "Activity": "Pits - New - P9",
        "Quantity/Metres": Number(document.getElementById('pit-new-p9-progress-qty')?.value) || 0,
        "Activity Photos": photos
      });
    }

    // Replaced Pits - C8
    if (document.getElementById('discipline-pit-replaced-c8-progress')?.checked) {
      btn.textContent = 'Uploading Replaced Pit C8 photos...';
      const photos = await uploadFilesToAirtable(
        document.getElementById('pit-replaced-c8-progress-photos')?.files || [],
        'progressRegister',
        'Replaced Pit C8 Photos'
      );
      activities.push({
        ...commonData,
        "Activity": "Pits - Replaced - C8",
        "Quantity/Metres": Number(document.getElementById('pit-replaced-c8-progress-qty')?.value) || 0,
        "Activity Photos": photos
      });
    }

    // Replaced Pits - C9
    if (document.getElementById('discipline-pit-replaced-c9-progress')?.checked) {
      btn.textContent = 'Uploading Replaced Pit C9 photos...';
      const photos = await uploadFilesToAirtable(
        document.getElementById('pit-replaced-c9-progress-photos')?.files || [],
        'progressRegister',
        'Replaced Pit C9 Photos'
      );
      activities.push({
        ...commonData,
        "Activity": "Pits - Replaced - C9",
        "Quantity/Metres": Number(document.getElementById('pit-replaced-c9-progress-qty')?.value) || 0,
        "Activity Photos": photos
      });
    }

    // Replaced Pits - Manhole
    if (document.getElementById('discipline-pit-replaced-manhole-progress')?.checked) {
      btn.textContent = 'Uploading Replaced Manhole photos...';
      const photos = await uploadFilesToAirtable(
        document.getElementById('pit-replaced-manhole-progress-photos')?.files || [],
        'progressRegister',
        'Replaced Manhole Photos'
      );
      activities.push({
        ...commonData,
        "Activity": "Pits - Replaced - Manhole",
        "Quantity/Metres": Number(document.getElementById('pit-replaced-manhole-progress-qty')?.value) || 0,
        "Activity Photos": photos
      });
    }

    // Replaced Pits - P5
    if (document.getElementById('discipline-pit-replaced-p5-progress')?.checked) {
      btn.textContent = 'Uploading Replaced Pit P5 photos...';
      const photos = await uploadFilesToAirtable(
        document.getElementById('pit-replaced-p5-progress-photos')?.files || [],
        'progressRegister',
        'Replaced Pit P5 Photos'
      );
      activities.push({
        ...commonData,
        "Activity": "Pits - Replaced - P5",
        "Quantity/Metres": Number(document.getElementById('pit-replaced-p5-progress-qty')?.value) || 0,
        "Activity Photos": photos
      });
    }

    // Replaced Pits - P6
    if (document.getElementById('discipline-pit-replaced-p6-progress')?.checked) {
      btn.textContent = 'Uploading Replaced Pit P6 photos...';
      const photos = await uploadFilesToAirtable(
        document.getElementById('pit-replaced-p6-progress-photos')?.files || [],
        'progressRegister',
        'Replaced Pit P6 Photos'
      );
      activities.push({
        ...commonData,
        "Activity": "Pits - Replaced - P6",
        "Quantity/Metres": Number(document.getElementById('pit-replaced-p6-progress-qty')?.value) || 0,
        "Activity Photos": photos
      });
    }

    // Replaced Pits - P8
    if (document.getElementById('discipline-pit-replaced-p8-progress')?.checked) {
      btn.textContent = 'Uploading Replaced Pit P8 photos...';
      const photos = await uploadFilesToAirtable(
        document.getElementById('pit-replaced-p8-progress-photos')?.files || [],
        'progressRegister',
        'Replaced Pit P8 Photos'
      );
      activities.push({
        ...commonData,
        "Activity": "Pits - Replaced - P8",
        "Quantity/Metres": Number(document.getElementById('pit-replaced-p8-progress-qty')?.value) || 0,
        "Activity Photos": photos
      });
    }

    // Replaced Pits - P9
    if (document.getElementById('discipline-pit-replaced-p9-progress')?.checked) {
      btn.textContent = 'Uploading Replaced Pit P9 photos...';
      const photos = await uploadFilesToAirtable(
        document.getElementById('pit-replaced-p9-progress-photos')?.files || [],
        'progressRegister',
        'Replaced Pit P9 Photos'
      );
      activities.push({
        ...commonData,
        "Activity": "Pits - Replaced - P9",
        "Quantity/Metres": Number(document.getElementById('pit-replaced-p9-progress-qty')?.value) || 0,
        "Activity Photos": photos
      });
    }

    // Marker Posts
    if (document.getElementById('discipline-markers-progress')?.checked) {
      btn.textContent = 'Uploading Marker Posts photos...';
      const photos = await uploadFilesToAirtable(
        document.getElementById('markers-progress-photos')?.files || [],
        'progressRegister',
        'Marker Posts Photos'
      );
      activities.push({
        ...commonData,
        "Activity": "Marker Posts",
        "Quantity/Metres": Number(document.getElementById('markers-progress-qty')?.value) || 0,
        "Activity Photos": photos
      });
    }

    // Submit all activity records to Progress Register
    btn.textContent = `Submitting records (0/${activities.length})...`;
    for (let i = 0; i < activities.length; i++) {
      btn.textContent = `Submitting records (${i + 1}/${activities.length})...`;
      await submitToAirtable('progressRegister', activities[i]);
    }

    showSuccessMessage();

  } catch (err) {
    console.error('Progress submission failed:', err);
    alert('Submission failed: ' + err.message);
  } finally {
    btn.disabled = false;
    btn.textContent = 'Submit Progress Register';
  }
});
});
</script>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA-EKPtC5W7fRHgiONVPIyGsVU7Ti_xjBc&libraries=places&loading=async&callback=initAutocomplete" async defer></script>